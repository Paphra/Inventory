extends ../layout

block content
          
  .container
    .row
      .col-sm-8
        blockquote
          i This displays all the Stock Items in the store.
      if user.admin
        .col-sm-4
          button.btn.btn-success.btn-block.btn-sm(
            data-toggle='modal' data-target='#add') New Item
          input(type='hidden')
          
          // include ../import

        .col-sm-12
          #add.modal.fade(
            tab-index='-1' role='dialog' aria-labelby='AddNewItem' 
            aria-hidden='true')
          
            if returned && returned.isImport
              - returned = false
          
            .modal-dialog(role='document')
              .modal-content
                - let url = (returned?returned.url:'')
                form(action=(url?url:'/stock'), method="post")
                  .modal-header
                    h4.modal-title #{returned?'Update': 'Add New'} Item
                    button.close(type='button' data-dismiss='modal' aria-label='Close')
                      span(aria-hidden='true') &times;
                  .modal-body
                    .errors
                        if returned
                          if returned.errors
                            ul
                              each err in returned.errors
                                li= err.msg
                    .form-group
                      .row
                        .col-sm-6
                          label(for="name") Name
                          input#name.form-control(
                            type="text" placeholder='Enter Name Of Stock Item'
                            required='true' name='name' value=(returned?returned.name:''))
                        
                        
                        .col-sm-6
                          label(for="category") Category
                          select#category.form-control(
                            placeholder='Select a Category' name='category'
                            required='true')
                            option(value="") -- Category --
                            each cat in categories
                              option(value=cat._id
                                selected=(returned?returned.category.toString()===cat._id.toString():false)
                                ) #{cat.name}
                            else
                              option(value="") No Categories

                    .form-group
                      label(for="supplier") Supplier
                      input#supplier.form-control(
                        type="text" placeholder="Supplier's Name"
                        required='true' name='supplier' value=(returned?returned.supplier:''))
                        
                    .form-group
                      label(for="description") Description
                      textarea#description.form-control(
                        name="description", rows="3" required='true' 
                        placeholder='Enter the Description of the Stock Item') #{returned?returned.description:''}

                  .modal-footer
                    button.btn.btn-success(type='submit') Save 
                    button.btn.btn-danger(type='button' data-dismiss='modal') Close
  
  hr
  .bg-white.shadow
    table#table.table.table-compressed.table-bordered(
      data-toggle="table"
      data-search="true"
      data-trim-on-search='false'
      data-show-columns="true"
      data-show-columns-search='true'
      data-show-columns-toggle-all='true'
      data-show-print='true'
      data-show-export='true'
      data-sort-class="table-active"
      data-sortable="true"
      data-pagination="true"
      data-show-pagination-switch='true'
      data-page-number="1"
      data-show-toggle='true'
      data-show-fullscreen='true'
      data-page-list="[10, 25, 50, 100, 200, All]"
      data-width='100%')

      thead
        tr
          th(data-sortable='true') #
          th(data-sortable='true') Name
          th Category
          th Supplier
          th 
            if user.admin
              i Total Qtty
            else
              i  Branch Qtty
          th Actions

      tbody
        if items.length
          - let count = 0
          each item in items
            - count += 1
            tr
              td #{count}
              td #{item.name}
              td #{item.category.name}
              td #{item.supplier}
              td
                // work out quantity
                - let qty = 0
                if user.admin
                  each qtty in quantities
                    if qtty.item.toString() === item._id.toString()
                      - qty += qtty.value
                else
                  each qtty in quantities
                    if qtty.branch.toString() === user.branch._id.toString() && qtty.item.toString() === item._id.toString()
                      - qty = qtty.value
                i= qty

              td
                if user.admin
                  span.btn.btn-primary.btn-sm(
                    data-target='#edit_' + item._id data-toggle='modal')
                    i.fas.fa-edit
                span.btn.btn-success.btn-sm(
                  data-target='#view_' + item._id data-toggle='modal')
                  i.fas.fa-eye
                - let hf = false
                each flow in flows
                  if flow.item._id.toString() === item._id.toString()
                    - hf = true
                if !hf && user.admin
                  span.btn.btn-danger.btn-sm(
                    data-target='#delete_' + item._id data-toggle='modal')
                    i.fas.fa-trash
          
              // editing
              .modal.fade( id='edit_' + item._id
                tab-index='-1' role='dialog' aria-labelby='EditItem' 
                aria-hidden='true')
                
                .modal-dialog(role='document')
                  .modal-content
                    form(action=item.url, method="post")
                      .modal-header
                        h4.modal-title Edit Item
                        button.close(type='button' data-dismiss='modal' aria-label='Close')
                          span(aria-hidden='true') &times;
                      .modal-body
                      
                        .form-group
                          .row
                            .col-sm-6
                              label(for="name") Name
                              input#name.form-control(
                                type="text" placeholder='Enter Name Of Stock Item'
                                required='true' name='name' value=item.name)
                            
                            .col-sm-6
                              label(for="category") Category
                              select#category.form-control(
                                placeholder='Select a Category' name='category'
                                required='true')
                                option(value="") -- Category --
                                each cat in categories
                                  option(
                                    value=cat._id
                                    selected=(cat._id.toString()===item.category._id.toString())
                                    ) #{cat.name}
                                else
                                  option(value="") No Categories
                        .form-group
                          label(for="supplier") Supplier
                          input#supplier.form-control(
                            type="text" placeholder="Supplier's Name"
                            required='true' name='supplier' value=item.supplier)
                            
                        .form-group
                          label(for="description") Description
                          textarea#description.form-control(
                            name="description", rows="3" required='true' 
                            placeholder='Enter the Description of the Stock Item') #{item.description}

                      .modal-footer
                        button.btn.btn-success(type='submit') Save 
                        button.btn.btn-danger(type='button' data-dismiss='modal') Close

              // view details
              .modal.fade( id='view_' + item._id
                tab-index='-1' role='dialog' aria-labelby='ViewItem' 
                aria-hidden='true')
                .modal-dialog(role='document')
                  .modal-content
                    .modal-header
                      h4.modal-title Item Details
                      button.close(type='button' data-dismiss='modal' aria-label='Close')
                        span(aria-hidden='true') &times;
                    .modal-body
                      .row
                        .col-4.text-right 
                          h5 #[strong Name:]
                        .col-8
                          h4 #{item.name}
                      .row
                        .col-4.text-right 
                          h5 #[strong Supplier:]
                        .col-8
                          h4 #{item.supplier}
                      .row
                        .col-4.text-right #[strong Category:]
                        .col-8
                          p #{item.category.name}
                      hr
                      .row
                        .col-4.text-right #[strong Description:]
                        .col-8
                          p #{item.description}

                    .modal-footer
                      button.btn.btn-primary(type='button' data-dismiss='modal') Close

              // deleting
              .modal.fade( id='delete_' + item._id
                tab-index='-1' role='dialog' aria-labelby='DeleteItem' 
                aria-hidden='true')
                .modal-dialog(role='document')
                  .modal-content
                    form(action=item.url + '/delete', method="post")
                      .modal-header
                        h4.modal-title Delete Item #{item.name}
                        button.close(type='button' data-dismiss='modal' aria-label='Close')
                          span(aria-hidden='true') &times;
                      .modal-body
                        input#stockid.form-control(
                          type="hidden" name='stockid' required='true'
                          value=item._id)
                        .row
                          .col-sm-4.text-right #[strong Description:] 
                          .col-sm-8 #{item.description}

                      .modal-footer
                        button.btn.btn-danger(type='submit') Delete
                        button.btn.btn-secondary(type='button' data-dismiss='modal') Cancel
